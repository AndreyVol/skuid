---
layout: main
title: Simple Map Component
---

Simple Map Component
=================

The following is the code for the Custom Map component that we'll build during our Dreamforce 2012 session "Unleash the Force.com User Interface with Skuid". 

There are only 3 files you need to create to add this Custom Map component to your Skuid org: 

+	CustomMap.class (Apex Class)
+	MapsBuildersJS.resource (Static Resource - JavaScript)
+	MapsJS.resource (Static Resource - JavaScript)

The only other step is to add a 'Maps' entry to the Skuid Page object's Module field. For an explanation of this, see [Creating a Skuid Module](http://plusplusben.github.com/skuid/devcreatemodule.html).

## Apex

{% highlight java %}

// Custom Components must extend nexus.NexusComponentImpl
global with sharing class CustomMap extends nexus.NexusComponentImpl {
    
    global override void generate(){
        this.htmlOutput = '<div id="' + componentId + '"></div>';
        // Load in the MapsJS Static Resource file,
        // which contains the code 
        // for our customMap jQuery plugin
        this.jsOutput = 'skuid.utils.loadJS(\'' 
        	+ nexus.NexusUtils.getResourceURL('MapsJS')
        	+ '\');\n';
        // Skuid helper function
        // that takes the div we just created
        // and runs our customMap jQuery plugin on it
        this.jsOutput += nexus.NexusUtils.MakePluginString(
        	componentId, // the DOM element to run our plugin on
        	'customMap', // The jQuery plugin to run on the element
        	nexus.NexusUtils.toXmlString(data) // The <custommap> XML node from our Page Layout
        );
            
    }
    
    global override List<nexus.ValidationError> validate() {
        return new List<nexus.ValidationError>();
    }
    
}

{% endhighlight %}

## JavaScript

### Map Builder JavaScript

The following should be included in a 'MapsBuildersJS' Static Resource:

{% highlight javascript %}

(function($) {

skuid.builder.registerBuilder(new skuid.builder.Builder({
	id : 'custommap',
	name : 'Custom Map',
	icon : 'ui-silk-map',
	description : 'This is a custom component.',
	componentRenderer: function(component) {
		var self = component;			
		component.header.html(component.builder.name);
	},
	propertiesRenderer : function (propertiesObj,component) {
		propertiesObj.header.text('Custom Map Properties');
		
		var propsMap = {
			model : {
				type : 'model',
				name : 'Model',
				required : true,
				onChange : function(value) {
					
				}
			},
			pincolor : {
				type : 'string',
				name : 'Pin Color'
			}
		}
		
		var propsEditor = skuid.builder.buildPropsEditor(component.state,propsMap);	
		propertiesObj.body.append(propsEditor);
		
	},
	defaultStateGenerator : function() {
		return $('<custommap>');
	}
}));

})(jQuery);

{% endhighlight %}

### Map Component JavaScript

Place the following in a 'MapsJS' Static Resource:

{% highlight javascript %}

(function( $ ){
       
    var methods = {
    	init : function (xmlDef) {
    		
    		// Lock-in a reference to this jQuery object
    		var self = this;
    		
    		// Get the model name from the component definition
    		var modelName = xmlDef.attr('model');
    		// Save our pin color to our model
    		self.pinColor = xmlDef.attr('pincolor');
    		
    		// Use the Skuid JavaScript API
    		// to get a reference
    		// to the requested Model
			self.model = skuid.model.getModel(modelName);
    		
    		// Establish ourselves as a Skuid Editor
    		self.editor = new skuid.ui.Editor(self,{
    			showHeader : false
    		});
    		// Register that we will be editing the Cases model.
        	self.editor.registerModel(self.model);
        	
        	// Define how we will handle successful 'saves' to our model
        	self.editor.handleSave = function(modelHasChanged) {
        		if (modelHasChanged) {
	    			// Redraw our Map
	        		self.customMap('draw');
        		}
    		};
    		
    		// Define how we will handle successful 'refreshes' to our model
        	self.editor.handleDataRefresh = function() {
	        		self.customMap('draw');
    		};
    		// Make sure our Map is at least a certain height
    		self.css('min-height','300px');
    		
    		// Draw our Map into our DOM element
    		self.customMap('draw');
    		
        }, 
        draw : function() {
        	
        	var self = this; 
        	
        	// Loop through the Case rows in our model
    		// and create a marker for each Case
    		self.markers = [];
    		$.each(self.model.data,function() {
    			self.markers.push(
    				'&markers=color:' + self.pinColor 
    				+ '%7C' + this.Latitude__c
    				 + ',' + this.Longitude__c
    			);
    		});
    		
    		// Create a map using google static maps api
    		self.googlemap && self.googlemap.remove();
    		self.googlemap = $('<img>')
    			.attr('src','https://maps.googleapis.com/maps/api/staticmap?size=600x300' 
    				+ self.markers.join('') 
    				+ '&maptype=roadmap'
    				+ '&sensor=false'
    			).css('margin-top','8px')
    			.appendTo(self);
        }
    }
    
    skuid.registerPlugin('customMap',methods);
    
})( jQuery );

{% endhighlight %}